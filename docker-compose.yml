version: '3.3'

services:
  elasticsearch:
    container_name: tqd-elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.21
    volumes:
      - esdata:/usr/share/elasticsearch/data
    environment:
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - discovery.type=single-node
    ports:
      - 9300:9300
      - 9200:9200
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s http://localhost:9200/_cat/health | grep -q 'green' || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  kibana:
    container_name: kibana
    image: docker.elastic.co/kibana/kibana:7.17.21
    ports:
      - 5601:5601
    environment:
      ELASTICSEARCH_URL: http://elasticsearch:9200
    depends_on:
      elasticsearch:
        condition: service_healthy

  backend:
    build:
      context: .
      dockerfile: ./server/v1/DockerFile
    depends_on:
      elasticsearch:
        condition: service_healthy
    env_file: .env
    volumes:
      - ./server/v1:/node/app
      - /node/app/node_modules
    ports:
      - ${NODE_PORT}:${NODE_PORT}
    container_name: node-app

  react-build:
    build:
      context: .
      dockerfile: ./web/DockerFile
    restart: always
    ports:
      - 3000:3000
    volumes:
      - ./web:/react/app
      - /react/app/node_modules
    container_name: react-app
    env_file: .env
    depends_on:
      - backend

volumes:
  esdata: # Define a named volume for persistent MySQL data
